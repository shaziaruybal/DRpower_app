---
title: "*pfhrp2/3* Planner: Analysis report"
date: "*Downloaded on: `r Sys.Date()` | DRpower interactive app v1.0.1*"
output: 
  html_document:
    # theme: flatly
      version: 5
      bg: "#F9F9F9"
      fg: "#5e5ea3"
      primary: "#5e5ea3"
      base_font: !expr bslib::font_google("Lato")
      code_font: !expr bslib::font_google("JetBrains Mono")
params:
  analysis_study_data: NA
  analysis_prevoutput: NA
  analysis_iccoutput: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(bslib)
library(kableExtra)
library(DRpower)

set.seed(10)
```

```{css, echo=F}
.title{
  color: #605ca3;
}

.date{
  color: #605ca3;
  text-align: right; 
  font-size: 14px;
}

/* Styles for the h3 headers */
h3 {
  color: #605ca3 !important;
}

hr {
  opacity: 1; 
  border-top: 2.5px solid #605ca3;
}
```

```{r create objects from params, echo=F}
study_data <- params$analysis_study_data
prev_output <- params$analysis_prevoutput
icc_output <- params$analysis_iccoutput
```
-----

### Background
This report presents the results generated by the [*pfhrp2/3* planner web application](https://shiny.dide.ic.ac.uk/DRpower-app/). This application was used to analyze data from a *pfhrp2/3* deletion prevalence study to estimate prevalence and determine if it is above the [WHO recommended prevalence threshold of 5%](https://iris.who.int/handle/10665/331197). This software uses a Bayesian hierarchical model implemented in the [DRpower R package](https://mrc-ide.github.io/DRpower) to estimate the prevalence of *pfhrp2/3* deletions causing false-negative HRP2 RDT results while accounting for correlations within clusters or health facilities/sites. For more information on the statistical method used, see the [DRpower R package website](https://mrc-ide.github.io/DRpower).

The statistical analysis framework involves calculation of a point estimate of the prevalence of deletions along with a 95% credible interval (CrI) to summarise results, with the probability that the prevalence of *pfhrp2/3* deletions is above 5% used to categorize study domains into outcome 1 or 2, as follows:

```{r echo=F}
knitr::include_graphics(path = "https://github.com/shaziaruybal/DRpower_app/blob/main/www/img/stats_framework_v1.png?raw=true")
```

### Study details 

A total of `r nrow(study_data)` health facilities (or sites) were surveyed in this *pfhrp2/3* deletion prevalence study. The observed counts of *pfhrp2/3* deletions causing false-negative HRP2 RDTs and the sample sizes in each health facility are shown below:

```{r echo=F}
kable(study_data, 
      format = "html", 
      col.names = c("Health facility", "Number of deletions", "Sample size")) %>%
  kable_styling(
    bootstrap_options = "striped",
    position = "left",
    full_width = F)
```

### Estimated prevalence 

To estimate the prevalence of *pfhrp2/3* deletions causing false-negative HRP2 RDTs, we used to test whether the observed prevalence in this study was above or below the 

**RESULT**: We estimate that the prevalence of *pfhrp2/3* deletions causing false-negative HRP2 RDTs is `r round(as.numeric(prev_output$MAP), 2)`% (95% CrI: `r round(as.numeric(prev_output$CrI_lower), 2)`-`r round(as.numeric(prev_output$CrI_upper), 2)`%). The probability that the prevalence is above the 5% threshold is estimated at `r round(as.numeric(prev_output$prob_above_threshold)*100, 2)`%. *We require greater than 95% probability to confidently conclude that prevalence is above the 5% threshold.*

##### CONCLUSION: The prevalence of *pfhrp2/3* deletions causing false-negative HRP2 RDTs within symptomatic *P. falciparum* patients is **`r if(prev_output$prob_above_threshold>0.95) "above" else "below"`** the 5% WHO threshold **`r if(prev_output$prob_above_threshold>0.95) "(Outcome 2)" else "(Outcome 1)"`**.

```{r fig.height=4, fig.width=6, echo=F, warning=F}
DRpower::plot_prevalence(n = study_data$n_deletions, N = study_data$sample_size) 
```

### Estimated intra-cluster correlation (ICC)

We estimate that the intra-cluster correlation is `r round(as.numeric(icc_output$MAP),2)` (95% CrI: `r round(as.numeric(icc_output$CrI_lower), 2)`-`r round(as.numeric(icc_output$CrI_upper),2)`).

```{r fig.height=4, fig.width=4, echo=F}
icc_output %>% 
  ggplot() +
        geom_segment(aes(x = " ", xend = " ", y = CrI_lower, yend = CrI_upper), 
                     color = "gray20", linewidth = 1) +
        geom_point(aes(x = " ", y = MAP), 
                   size = 2, 
                   shape = 21,
                   fill = "mediumpurple") +
        scale_y_continuous(limits = c(0,1)) +
        labs(x = "",
             y = "Estimated ICC") +
        theme_light() +
        theme(text = element_text(size = 12)) 
```
